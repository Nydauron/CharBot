require("http").createServer(async (req,res) => { res.statusCode = 200; res.write("ok"); res.end(); }).listen(3000, () => console.log("Now listening on port 3000"));const Discord=require("discord.js"),client=new Discord.Client,config=require("./config.json"),guildSettings=require("./guildsettings.json"),changeLog=require("./changelog.json"),jsonfile=require("jsonfile"),http=require("http"),request=require("request"),$=require("jquery")(require("jsdom-no-contextify").jsdom().parentWindow),bfdAPI=require("bfd-js-api"),bfd=new bfdAPI(client,config.botsForDiscordToken,!0,900),DBL=require("dblapi.js"),dbl=new DBL(config.discordBotsListToken,{statsInterval:9e5},client),post=require("superagent"),listOfRoasts=config.roasts,date=new Date;var settings,roasts=require("./roasts.json"),activityInt=1,setTimeoutIDs=[];function recreateSettings(){var e=client.guilds,n=[];for(let t of e)n.push(t);console.log(n);for(var t=[],s=0;s<n.length;s++){for(var i={id:n[s][0],channels:[]},a=n[s][1].channels.array(),o=0;o<a.length;o++)i.channels.push({id:a[o].id,settings:{randomTimeInterval:{value:"disable",interval:0,chance:0,date:Date.now()},mention:"disable"}});t.push(i)}var l=JSON.stringify(t),r=require("fs");r.writeFile("./guildsettings.json.backup",l,"utf8",function(e){if(e)throw e}),r.writeFile("./guildsettings.json",l,"utf8",function(e){if(e)throw e})}function writeToFileCallback(e,n,t){var s=JSON.stringify(e);require("fs").writeFile(n,s,"utf8",function(e){if(e)throw e;console.log(t)})}function writeToFile(e,n){var t=JSON.stringify(e);require("fs").writeFile(n,t,"utf8",function(e){if(e)throw e})}function updateRoasts(){$.ajax({url:"https://mzz9x5fx61.execute-api.us-east-1.amazonaws.com/dev/shittalk/all",contentType:"application/json; charset=utf-8",type:"GET",dataType:"json",success:function(e){array=e.data.random;for(var n=0;n<array.length;n++){var t=array[n];if(!(t.net_votes<10)){var s=t.submission||"",i=binarySearch(roasts,s);if(i<0)for(var a=0;a<=roasts.length;a++){if(a==roasts.length){roasts.push(t);break}if(s.localeCompare(roasts[a].submission)<0){roasts.splice(a,0,t);break}}else roasts[i]=t}}writeToFileCallback(roasts,"./roasts.json","Roast List Updated. Roast list has a size of "+roasts.length+".")},error:function(e){console.log(e)}})}function binarySearch(e,n){for(var t=0,s=e.length-1;t<=s;){var i=t+(s-t)/2,a=n.localeCompare(e[Math.floor(i)].submission);if(0==a)return i;a>0?t=i+1:s=i-1}return-1}function getRoasts(e,n,t,s){var i={title:roasts[Math.floor(Math.random()*roasts.length)].submission,color:16711680},a=e.guild.id;if(s)return i;if("enable"===t)e.send("<@"+n+">",{embed:i});else if("disable"===t){var o=client.guilds.get(a).members,l=(o.array(),""),r=o.get(n);n===r.user.id&&(l=null==r.nickname?r.user.username:r.nickname),e.send(l,{embed:i})}}function roast(e,n,t,s){var i=client.channels.get(e),a=(i.guild.memberCount,i.members),o=[];for(let e of a)o.push(e);if(n===config.id)i.send("Why would I roast myself <@"+t+">? lol"),getRoasts(i,t,s,!1);else if("randomInterval"===n){do{l=o[Math.floor(Math.random()*o.length)][0]}while(l===config.id);getRoasts(i,l,s,!1)}else if("random"===n){var l;do{l=o[Math.floor(Math.random()*o.length)][0]}while(l===config.id);getRoasts(i,l,s,!1)}else if("everyone"===n){i.send("<@"+t+"> has summoned an avalanche of dead bodies.");for(var r=0,d=0;d<o.length;d++)o[d][0]!==config.id&&"1"!==o[d][0]&&(getRoasts(i,o[d][0],s,!1),r++);i.send("Castualties: "+r)}else getRoasts(i,n,s,!1)}function generateRoast(){var e=Math.floor(Math.random()*listOfRoasts.length);return listOfRoasts[e].substring(4)}function help(e){var n;n=e.member.hasPermission("KICK_MEMBERS")||e.member.id==config.owner?{title:"THE ADMIN COMMANDS",description:"All these commands can be used in casual conversation. Just mention me and I will come to your service.",color:16750899,fields:[{name:"!roast <username> *or* roast <username>",value:"Roasts user on demand.\n<username> = @ <username>, everyone, random"},{name:"!roast <help|?> *or* @CharBot <help|?>",value:"Brings up this list of commands."},{name:"!roast settings <settingName> [value]",value:"Brings up this list of settings and is used to edit setting values. MUST HAVE KICK PERMISSION."},{name:"!roast changelog",value:"Shows the changelog of the bot."}]}:{title:"BASIC COMMANDS",description:"All these commands can be used in casual conversation. Just mention me and I will come to your service.",color:16750899,fields:[{name:"!roast <username> *or* roast <username>",value:"Roasts user on demand.\n<username> = @ <username>, everyone, random"},{name:"!roast <help|?> *or* @CharBot <help|?>",value:"Brings up this list of commands."},{name:"!roast changelog",value:"Shows the changelog of the bot."}]},e.channel.send({embed:n})}function settingsHelp(e,n,t){var s="randomTimeInterval = "+settings.guilds[n].channels[t].settings.randomTimeInterval.value+"d";"enable"===settings.guilds[n].channels[t].settings.randomTimeInterval.value&&(s+=" Interval: "+settings.guilds[n].channels[t].settings.randomTimeInterval.interval+" mins Chance: "+100*settings.guilds[n].channels[t].settings.randomTimeInterval.chance+"%");var i={title:"SETTINGS",description:"All the settings on this server.",color:16750899,fields:[{name:s,value:"Allows bot to roast someone random on server at a random time. (Channel Setting)"},{name:"mentions = "+settings.guilds[n].channels[t].settings.mention+"d",value:"Allows the bot to mention other users on server. Can be really annoying if spammed. (Channel Setting)"}]};e.channel.send({embed:i})}function randomIntervalRoast(e,n,t,s){var i=Math.floor(6e4*settings.guilds[n].channels[t].settings.randomTimeInterval.interval),a=Date.now()+i;settings.guilds[n].channels[t].settings.randomTimeInterval.date=a;var o=JSON.stringify(settings),l=require("fs");l.writeFile("./guildsettings.json.backup",o,"utf8",function(e){if(e)throw e}),l.writeFile("./guildsettings.json",o,"utf8",function(e){if(e)throw e});client.channels.get(e);var r=setTimeout(function(){const s=n,i=t,a=e,o=settings.guilds[n].channels[t].settings.randomTimeInterval.value;for(var l=setTimeoutIDs.length-1;l>=0;l--)if(a===setTimeoutIDs[l].channel){clearTimeout(setTimeoutIDs[l].timeOut),setTimeoutIDs.splice(l,1);break}"enable"===o&&(Math.random()<parseFloat(settings.guilds[s].channels[i].settings.randomTimeInterval.chance)&&roast(a,"randomInterval",null,settings.guilds[n].channels[t].settings.mention),setTimeoutIDs.push({timeOut:randomIntervalRoast(a,s,i),channel:a}))},i);return r}function resetGuildSettings(e){for(var n=0;n<guilds.length;n++)e===settings.guilds[n].id&&settings.guilds.splice(n,1);var t={id:e,channels:[]},s=client.guilds.get(e).channels.array();for(n=0;n<s.length;n++)t.channels.push({id:s[n].id,settings:{randomTimeInterval:{value:"disable",interval:0,chance:0,date:Date.now()},mention:"disable"}});settings.guilds.push(t),updateSettingsJson()}function resetChannelSettings(e){for(var n=client.channels.get(e).guild.id,t=0;t<guilds.length;t++){var s=guilds[t].channels;if(n===settings.guilds[t].id){for(var i=0;i<s.length;i++)if(e===s[i].id){settings.guilds[t].channels.splice(i,1),settings.guilds[t].channels.push({id:e,settings:{randomTimeInterval:{value:"disable",interval:0,chance:0,date:Date.now()},mention:"disable"}});break}break}}updateSettingsJson()}function updateSettingsJson(){writeToFileCallback(settings,"./guildsettings.json","updated guildsettings.json")}function requestChangelog(e){for(var n=[],t=0;t<changeLog.length;t++){var s={name:"_**Version "+changeLog[t].version+"**_",value:""};if(changeLog[t].features.length>0){s.value+="__**Features & Changes**__\n";for(var i=0;i<changeLog[t].features.length;i++)s.value+=" - "+changeLog[t].features[i]+"\n"}if(changeLog[t].bugfixes.length>0){s.value+="\n__**Bug Fixes**__\n";for(i=0;i<changeLog[t].bugfixes.length;i++)s.value+=" - "+changeLog[t].bugfixes[i]+"\n"}s.value+="\n",n.push(s)}var a={title:"Changelog",fields:n,color:1996031,footer:{text:"Nydauron"},timestamp:"2019-04-20T18:39:56.004Z"};e.channel.send({embed:a})}client.on("ready",()=>{console.log(`Bot has started, with ${client.users.size} users, in ${client.channels.size} channels of ${client.guilds.size} guilds.`),settings=guildSettings,guilds=settings.guilds;for(var e=0;e<guilds.length;e++)for(var n=guilds[e].channels,t=0;t<n.length;t++)if("enable"===n[t].settings.randomTimeInterval.value){var s=parseInt(n[t].settings.randomTimeInterval.date)-Date.now();const l=n[t].id;var i=e,a=t;if(s<0)console.log("CREATING NEW SETTIMEOUT"),setTimeoutIDs.push(randomIntervalRoast(l,i,a));else{console.log("ROAST IN "+new Date(Date.now()+s).toString());var o=setTimeout(function(){const e=i,n=a,t=l,s=o,r=settings.guilds[e].channels[n].settings.randomTimeInterval.value;var d=setTimeoutIDs.indexOf(s);(d>-1&&setTimeoutIDs.splice(d,1),"enable"===r)&&(Math.random()<parseFloat(settings.guilds[e].channels[n].settings.randomTimeInterval.chance)&&roast(t,"randomInterval",null,settings.guilds[e].channels[n].settings.mention),setTimeoutIDs.push({timeOut:randomIntervalRoast(t,e,n),channel:t}))},s);setTimeoutIDs.push({timeOut:o,channel:l})}}var l=changeLog[changeLog.length-1].version;updateRoasts(),setInterval(function(){updateRoasts()},3e5),setInterval(function(){switch(++activityInt>2&&(activityInt=1),activityInt){case 1:client.user.setActivity("with fire | v"+l,{type:"PLAYING"});break;case 2:client.user.setActivity('"!roast ?" for help',{type:"LISTENING"});break;case 3:client.user.setActivity("${client.users.size} plebs",{type:"WATCHING"})}},2e4),client.user.setActivity("with fire | v"+l,{type:"PLAYING"}),console.log("Charbot v"+l+" is completed boot! Awaiting commands...")}),client.on("guildCreate",e=>{console.log(`New guild joined: ${e.name} (id: ${e.id}). This guild has ${e.memberCount} members!`);for(var n={id:e.id,channels:[]},t=e.channels.array(),s=0;s<t.length;s++)n.channels.push({id:t[s].id,settings:{randomTimeInterval:{value:"disable",interval:0,chance:0,date:Date.now()},mention:"disable"}});settings.guilds.push(n),writeToFileCallback(settings,"./guildsettings.json","added "+e.name+" to guildsettings.json")}),client.on("guildDelete",e=>{console.log(`I have been removed from: ${e.name} (id: ${e.id})`);for(var n=0;n<guilds.length;n++)e.id===settings.guilds[n].id&&settings.guilds.splice(n,1);writeToFileCallback(settings,"./guildsettings.json","removed "+e.name+" from guildsettings.json")}),client.on("channelCreate",e=>{console.log(`I have been added to: ${e.name} (id: ${e.id})`);for(var n=0;n<guilds.length&&null!=e.guild.id;n++)if(e.guild.id===guilds[n].id){settings.guilds[n].channels.push({id:e.id,settings:{randomTimeInterval:{value:"disable",interval:0,chance:0,date:Date.now()},mention:"disable"}});break}writeToFileCallback(settings,"./guildsettings.json","added "+e.name+" to guildsettings.json")}),client.on("channelDelete",e=>{console.log(`I have been removed from: ${e.name} (id: ${e.id})`);for(var n=0;n<guilds.length;n++){var t=guilds[n].channels;if(e.guild.id===settings.guilds[n].id){for(var s=0;s<t.length;s++)if(e.id===t[s].id){settings.guilds[n].channels.splice(s,1);break}break}}writeToFileCallback(settings,"./guildsettings.json","removed "+e.name+" to guildsettings.json")}),bfd.on("posted",e=>{console.log(`Success! Posted ${e} Guilds to botsfordiscord.com`)}),bfd.on("error",e=>{console.log(`BFD has errored!\n${e}`)}),dbl.on("posted",()=>{console.log("Success! Posted ${guildCount} Guilds to discordbots.org")}),dbl.on("error",e=>{console.log(`DBL has errored!\n${e}`)}),client.on("message",async e=>{var n="disable",t=!1,s=!1;for(l=0;l<settings.guilds.length;l++)if(e.guild.id===settings.guilds[l].id){t=!0;for(var i=0;i<settings.guilds[l].channels.length;i++)if(e.channel.id===settings.guilds[l].channels[i].id){s=!0,n=settings.guilds[l].channels[i].settings.mention;break}break}if(t||resetGuildSettings(e.channel.guild.id),s||resetChannelSettings(e.channel.id),e.author.bot)return;if(0!==e.content.indexOf(config.prefix)){const t=e.content.split(" ");for(var a=!1,o=!1,l=0;l<t.length;l++)if(t[l]==="<@"+config.id+">"){o=!0;break}e.channel.guild.memberCount;var r=e.channel.guild.members,d=[];for(let e of r)d.push(e);for(l=0;l<t.length;l++){var g=t[l].toLowerCase();if("roast"===g&&l+1!==t.length){if(t[l+1]==="<@"+config.id+">"||"yourself"===t[l+1])roast(e.channel.id,config.id,e.author.id,n),a=!0;else if("me"===t[l+1].toLowerCase())o&&e.channel.send("Got it! One well done <@"+e.author.id+">..."),roast(e.channel.id,e.author.id,e.author.id,n),a=!0;else if("everyone"===t[l+1].toLowerCase()||"random"===t[l+1].toLowerCase())"random"===t[l+1]&&o&&e.channel.send("As you wish, <@"+e.author.id+">."),roast(e.channel.id,t[l+1],e.author.id,n),a=!0;else if(0==t[l+1].toLowerCase().indexOf("<@")&&t[l+1].toLowerCase().indexOf(">")==t[l+1].length-1){o&&e.channel.send("As you wish, <@"+e.author.id+">.");var u=2;"<@!"==t[l+1].substring(0,3)&&(u=3),roast(e.channel.id,t[l+1].substring(u,t[l+1].length-1),e.author.id,n),a=!0}console.log("["+e.guild.name+"]  "+e.author.username+"#"+e.author.discriminator+": "+e.content)}"help"!==g&&"?"!==g||!o||(e.channel.send("Some assistance for you <@"+e.author.id+">."),help(e),a=!0);for(i=0;i<config.greetings.length;i++)-1!=e.content.toLowerCase().indexOf(config.greetings[i])&&o&&(e.channel.send("<@"+e.author.id+"> I roast people for a living..."),a=!0);if(a)break}return void(!a&&o&&(e.channel.send("<@"+e.author.id+">! You summoned me! What is it that you request?"),console.log("["+e.guild.name+"]  "+e.author.username+"#"+e.author.discriminator+": "+e.content)))}console.log("["+e.guild.name+"]  "+e.author.username+"#"+e.author.discriminator+": "+e.content);const c=e.content.slice(config.prefix.length).trim().split(/ +/g),h=c.shift().toLowerCase();if(h==="<@"+config.id+">")e.channel.send("Hmmmmm... So, <@"+e.author.id+"> thinks they can trick me... Hmmmmmmmmmmmmmmmmmmmmmmmm... I DON'T THINK SO!! HAHA!"),roast(e.channel.id,config.id,e.author.id,n);else if(0==h.indexOf("<@")&&h.indexOf(">")==h.length-1){u=2;"<@!"==h.substring(0,3)&&(u=3),roast(e.channel.id,h.substring(u,h.length-1),e.author.id,n)}else"everyone"!==h&&"random"!==h||roast(e.channel.id,h,e.author.id,n);if("changelog"===h&&requestChangelog(e),"settings"===h){if(e.member.hasPermission("KICK_MEMBERS")||e.author.id===config.owner){var m=settings.guilds;for(l=0;l<m.length;l++)if(m[l].id===e.channel.guild.id){var f=m[l].channels;for(i=0;i<f.length;i++)if(e.channel.id===f[i].id){if(0==c.length)settingsHelp(e,l,i);else if("randomTimeInterval"===c[0]){if(1==c.length)"enable"===f[i].settings.randomTimeInterval.value?(plural="s",1==f[i].settings.randomTimeInterval.interval&&(plural=""),e.channel.send("Intervals are set to "+f[i].settings.randomTimeInterval.interval+" minute"+plural+" with a "+100*f[i].settings.randomTimeInterval.chance+"% chance of roasting someone.")):e.channel.send("Random interval roasting is disabled.");else if("disable"===c[1]||"enable"===c[1]){var v=!0,b=f[i].settings.randomTimeInterval.value;if(f[i].settings.randomTimeInterval.value=c[1],"enable"===c[1]){for(var p=[30,.2],I=0;I<p.length;I++)if(c.length>I+2){var T=parseFloat(c[I+2]);if("number"!=typeof T){e.channel.send("<@"+e.author.id+"> These are invalid arguments! :angry:"),v=!1;break}p[I]=T}f[i].settings.randomTimeInterval.interval=p[0],f[i].settings.randomTimeInterval.chance=p[1],"disable"===b&&setTimeoutIDs.push({timeOut:randomIntervalRoast(e.channel.id,l,i),channel:e.channel.id})}else if("disable"===c[1])for(I=setTimeoutIDs.length-1;I>=0;I--)e.channel.id===setTimeoutIDs[I].channel&&(clearTimeout(setTimeoutIDs[I].timeOut),setTimeoutIDs.splice(I,1));else e.channel.send('The arguments here are to "enable" or to "disable", not "'+c[1]+'".');v&&(b===c[1]?e.channel.send("It seems that randomTimeInterval was already "+c[1]+"d."):e.channel.send("randomTimeInterval is now "+c[1]+"d."),writeToFile(settings,"./guildsettings.json"))}}else if("reset"===c[0])c.length<2?e.channel.send("<@"+e.author.id+"> That is not enough arguments! Please, I don't know what you want to do!"):c.length>2?e.channel.send("<@"+e.author.id+"> That is too much information! Please remove some arguments."):2==c.length&&("guild"===c[1]?(resetGuildSettings(e.channel.guild.id),e.channel.send("Guild settings have been reset to the default.")):"channel"===c[1]?(resetChannelSettings(e.channel.id),e.channel.send("Channel settings have been reset to the default. Any guild settings not been adjusted.")):e.channel.send("<@"+e.author.id+'> You must mention "guild" or "channel".'));else if("mentions"===c[0])if(1==c.length)e.channel.send("Mentions are "+f[i].settings.mention+"d.");else if("enable"===c[1]||"disable"===c[1]){var w=f[i].settings.mention;f[i].settings.mention=c[1],c[1]===w?e.channel.send("Mentions are already been "+c[1]+"d for this channel."):e.channel.send("Mentions have been "+c[1]+"d for this channel."),updateSettingsJson()}else e.channel.send('The arguments here are to "enable" or to "disable", not "'+c[1]+'".');break}}}else e.channel.send("<@"+e.author.id+"> WHAT ARE YOU DOING TOUCHING MY PRIVATE PARTS!")}"help"!==h&&"?"!==h||help(e),e.author.id!==config.owner&&e.author.id!==config.admins||"ping"===h&&console.log(e.channel.guild.id)}),client.on("messageReactionAdd",(e,n)=>{}),client.on("disconnect",function(e,n){if(console.log("disconnected...."),0===n)return console.error(e);client.connect(),console.log("Connected")}),client.on("error",function(){console.error}),client.login(config.token);